<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sichern</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="layout">
  <aside id="site_sidebar" class="sidebar"></aside>
  <main class="content container">
    <h1>Sichern</h1>
    <div class="card">
      <div class="inline small">
        <button id="export_json_btn" class="btn">Exportieren (JSON)</button>
        <button id="import_json_btn" class="btn">Importieren (JSON)</button>
        <input id="import_json_input" type="file" accept="application/json" class="hidden">
        <span id="sichern_status" class="status"></span>
      </div>
      <div class="muted small">Exportiert/Importiert alle App-Daten als JSON.</div>
    </div>
  </main>
</div>
<script src="js/common.js"></script>
<script src="js/app.js"></script>
<script>
App.injectSidebar('sichern');

// Sichern functionality
(function(){
  function byId(id){ return document.getElementById(id); }
  function setStatus(msg, isError){
    var el = byId('sichern_status');
    if (!el) return;
    el.textContent = msg || '';
    if (el.classList) el.classList.toggle('danger', !!isError);
  }
  function collectAllLocalStorage(){
    var data = {};
    for (var i=0;i<localStorage.length;i++){
      var key = localStorage.key(i);
      try { data[key] = localStorage.getItem(key); } catch(e){}
    }
    return data;
  }
  function exportAll(){
    var payload = {
      type: 'Rechnungstool-Backup',
      version: 1,
      exportedAt: new Date().toISOString(),
      origin: location.origin,
      data: collectAllLocalStorage()
    };
    var blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    var ts = new Date().toISOString().slice(0,19).replace(/[T:]/g,'-');
    a.download = 'rechnungstool-backup-' + ts + '.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    setStatus('Export erstellt.');
  }
  function importFromFile(file){
    var reader = new FileReader();
    reader.onerror = function(){ setStatus('Datei konnte nicht gelesen werden.', true); };
    reader.onload = function(){
      try{
        var obj = JSON.parse(reader.result);
        var data = obj && obj.data && typeof obj.data==='object' ? obj.data : obj;
        if (!data || typeof data!== 'object'){ setStatus('Ungültiges JSON-Format.', true); return; }
        Object.keys(data).forEach(function(k){
          var v = data[k];
          if (typeof v === 'string') localStorage.setItem(k, v);
          else localStorage.setItem(k, JSON.stringify(v));
        });
        setStatus('Import erfolgreich.');
      }catch(e){ setStatus('Import fehlgeschlagen: Ungültiges JSON.', true); }
    };
    reader.readAsText(file);
  }
  function init(){
    var exportBtn = byId('export_json_btn');
    var importBtn = byId('import_json_btn');
    var fileInput = byId('import_json_input');
    if (!exportBtn || !importBtn || !fileInput) return;
    exportBtn.addEventListener('click', exportAll);
    importBtn.addEventListener('click', function(){ fileInput.value=''; fileInput.click(); });
    fileInput.addEventListener('change', function(e){ var f = e.target.files && e.target.files[0]; if (f) importFromFile(f); });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>
</body>
</html>