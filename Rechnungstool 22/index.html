<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rechnungstool</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <nav class="side">
        <div class="brand">Rechnungstool</div>
        <a href="#" class="navlink active" data-view="create">Rechnung stellen</a>
        <a href="#" class="navlink" data-view="firm">Firmen</a>
        <a href="#" class="navlink" data-view="customers">Kunden</a>
        <a href="#" class="navlink" data-view="products">Produkte</a>
        <a href="#" class="navlink" data-view="saved">Gespeichert</a>
        <a href="#" class="navlink" data-view="issued">Gestellt</a>
        <a href="#" class="navlink" data-view="paid">Bezahlte</a>
        <a href="#" class="navlink" data-view="sichern">Sichern ðŸ”’</a>
      </nav>
    </aside>
    <main class="content container">
      <section id="view-create">
        <h1>Rechnung stellen</h1>
        <div class="card">
          <div class="grid1">
            <label>Rechnungstitel<input id="inv_title" placeholder="z.B. Flugdienst"></label>
          </div>
          <div class="grid3">
            <label>Firma<select id="firm_select"></select></label>
            <label>Kunde<select id="sel_customer"></select></label>
            <label>MWST (%)<input id="vat" type="number" step="0.1" min="0" value="0"></label>
          </div>
          <div class="grid3">
            <label>Rechnungsnr.<input id="inv_no"></label>
            <span></span>
            <span></span>
          </div>
        </div>
        <div class="card" id="items_card">
          <h2>Positionen</h2>
          <div class="items-controls">
            <label>Produkt<select id="sel_product"></select></label>
            <label>Menge<input id="qty" type="number" min="1" step="1" value="1"></label>
            <button id="add_item" class="btn">HinzufÃ¼gen</button>
          </div>
          <div class="free-controls">
            <label>Freitext<input id="free_text_desc" placeholder="Bezeichnung"></label>
            <label>Menge<input id="free_text_qty" type="number" min="1" step="1" value="1"></label>
            <label>Preis<input id="free_text_price" type="number" min="0" step="0.05" value="0"></label>
            <button id="add_free_item" class="btn">Freie Position</button>
          </div>
          <div class="table-wrap">
            <table class="table items" id="items">
              <thead>
                <tr><th>#</th><th>Bezeichnung</th><th>Menge</th><th>Preis</th><th>Total</th><th></th></tr>
              </thead>
              <tbody>
                <!-- ...existing rows created by JS... -->
              </tbody>
            </table>
          </div>
          <div class="totals-panel">
            <div class="row"><span>Zwischensumme</span><strong id="sum">CHF 0.00</strong></div>
            <div class="row"><span>MWST</span><strong id="vat_amt">CHF 0.00</strong></div>
            <div class="row grand"><span>GESAMT</span><strong id="grand">CHF 0.00</strong></div>
          </div>
        </div>
        <div class="card">
          <h2>Flugdaten</h2>
          <div class="grid4">
            <label>Datum<input id="flight_date" type="date"></label>
            <label>Dep<input id="flight_dep" maxlength="4"></label>
            <label>Arr<input id="flight_arr" maxlength="4"></label>
            <label>Zeit<input id="flight_time"></label>
          </div>
          <label>Routing<input id="flight_routing"></label>
          <div class="inline"><button id="add_flight_data" class="btn">Flug hinzufÃ¼gen</button><span id="flight_feedback" class="status"></span></div>
          <div id="flight_table_wrap" style="display:none">
            <table class="table" id="flight_table"><thead><tr><th>Datum</th><th>Dep</th><th>Arr</th><th>Zeit</th><th>Routing</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h2>Passagiere</h2>
          <div class="inline small">
            <label>Kunde<select id="passenger_customer_select"></select></label>
            <label>Vorname<input id="passenger_fname"></label>
            <label>Nachname<input id="passenger_lname"></label>
            <button id="add_passenger" class="btn">HinzufÃ¼gen</button><span id="passenger_feedback" class="status"></span>
          </div>
          <table class="table" id="passenger_table"><thead><tr><th>#</th><th>Vorname</th><th>Nachname</th><th></th></tr></thead><tbody id="passenger_list"></tbody></table>
        </div>
        <div class="card inline">
          <button id="save_invoice" class="btn ok">Rechnung speichern</button>
          <span id="status" class="status"></span>
        </div>
      </section>

      <section id="view-firm" class="hidden">
        <h1>Firmen</h1>
        <section class="card">
          <h2>Firma erfassen / bearbeiten</h2>
          <div class="grid2">
            <label>Name<input id="cred_name"></label>
            <label>IBAN<input id="cred_iban"><span id="iban_feedback" class="danger"></span></label>
            <label>StraÃŸe<input id="cred_street"></label>
            <label>Nr.<input id="cred_no"></label>
            <label>PLZ<input id="cred_zip"></label>
            <label>Ort<input id="cred_city"></label>
            <label>Land<select id="cred_country"><option value="CH">CH</option><option value="LI">LI</option></select></label>
            <label>Logo<input type="file" id="cred_logo" accept="image/png,image/jpeg,image/webp"></label>
          </div>
          <div class="inline">
            <button id="add_firm" class="btn">Speichern</button>
            <button id="update_firm" class="btn hidden">Ã„nderungen speichern</button>
            <button id="cancel_update_firm" class="btn hidden">Abbrechen</button>
            <span id="firm_form_status" class="status"></span>
          </div>
          <div class="logo-preview"><img id="cred_logo_preview" style="display:none;max-height:64px" alt="Logo"></div>
          <div id="cred_logo_feedback" class="muted"></div>
        </section>
        <section class="card">
          <h2>Standard-Firma</h2>
          <div id="firm_summary" class="small"></div>
        </section>
        <section class="card">
          <h2>Firmenliste</h2>
          <table class="table" id="firm_table"><thead><tr><th>Name</th><th>IBAN</th><th>Adresse</th><th>Ort</th><th>Land</th><th>Std</th><th></th></tr></thead><tbody id="firm_list"><tr><td colspan="7" class="muted">Ladeâ€¦</td></tr></tbody></table>
        </section>
      </section>

      <section id="view-customers" class="hidden">
        <h1>Kunden</h1>
        <section class="card">
          <h2>Kunde erfassen / bearbeiten</h2>
          <label class="inline"><input type="checkbox" id="cust_is_company"> Firmenkunde</label>
          <div id="cust_private_fields">
            <div class="grid2">
              <label>Vorname<input id="cust_fname"></label>
              <label>Nachname<input id="cust_lname"></label>
            </div>
          </div>
          <div id="cust_company_fields" class="hidden">
            <div class="grid2">
              <label>Firma<input id="cust_company_name"></label>
              <label>Kontaktperson<input id="cust_contact_person"></label>
            </div>
          </div>
          <div class="grid3">
            <label>StraÃŸe<input id="cust_street"></label>
            <label>Nr.<input id="cust_no"></label>
            <label>PLZ<input id="cust_zip"></label>
            <label>Ort<input id="cust_city"></label>
            <label>Land<select id="cust_country"><option value="CH">CH</option><option value="LI">LI</option></select></label>
          </div>
          <div class="inline">
            <button id="add_customer" class="btn">Speichern</button>
            <button id="update_customer" class="btn hidden">Ã„nderungen speichern</button>
            <button id="cancel_update_customer" class="btn hidden">Abbrechen</button>
          </div>
        </section>
        <section class="card">
          <h2>Kundenliste</h2>
          <table class="table" id="cust_table"><thead><tr><th>Name</th><th>Adresse</th><th>Ort</th><th>Land</th><th></th></tr></thead><tbody id="cust_list"></tbody></table>
        </section>
      </section>

      <section id="view-products" class="hidden">
        <h1>Produkte</h1>
        <section class="card">
          <h2>Produkt erfassen</h2>
          <div class="grid2">
            <label>Name<input id="prod_name"></label>
            <label>Preis (CHF)<input type="number" id="prod_price" step="0.05" min="0"></label>
          </div>
          <button id="add_product" class="btn">Speichern</button>
        </section>
        <section class="card">
          <h2>Produktliste</h2>
          <table class="table" id="prod_table"><thead><tr><th>Name</th><th class="right">Preis</th><th></th></tr></thead><tbody id="prod_list"></tbody></table>
        </section>
      </section>

      <section id="view-sichern" class="hidden">
        <h1>Sichern</h1>
        <div class="card">
          <h2>Backup & Wiederherstellung</h2>
          <div class="inline small">
            <button id="export_json_btn" class="btn">ðŸ“¤ Exportieren (JSON)</button>
            <button id="import_json_btn" class="btn">ðŸ“¥ Importieren (JSON)</button>
            <input id="import_json_input" type="file" accept="application/json" class="hidden">
          </div>
          <div class="muted small">Exportiert/Importiert alle App-Daten als JSON.</div>
          <div class="small"><span id="sichern_status" class="status"></span></div>
        </div>
      </section>

      <section id="view-saved" class="hidden">
        <h1>Gespeicherte Rechnungen</h1>
        <table class="table" id="saved_invoices_table"><thead><tr><th>Nr.</th><th>Titel</th><th>Datum</th><th>Kunde</th><th>Firma</th><th class="right">Total</th><th></th></tr></thead><tbody id="saved_invoices_list"></tbody></table>
      </section>

      <section id="view-issued" class="hidden">
        <h1>Gestellte Rechnungen</h1>
        <table class="table" id="issued_invoices_table"><thead><tr><th>Nr.</th><th>Titel</th><th>Datum</th><th>Kunde</th><th>Firma</th><th class="right">Total</th><th></th></tr></thead><tbody id="issued_invoices_list"></tbody></table>
      </section>

      <section id="view-paid" class="hidden">
        <h1>Bezahlte Rechnungen</h1>
      </section>
    </main>
  </div>
  <script src="js/app.js"></script>
  <script>
    (function(){
      var link = document.querySelector('.navlink[data-view="sichern"]');
      var target = document.getElementById('view-sichern');
      if (!link || !target) return;
      link.addEventListener('click', function(e){
        e.preventDefault();
        document.querySelectorAll('main section[id^="view-"]').forEach(function(s){ s.classList.add('hidden'); });
        target.classList.remove('hidden');
        document.querySelectorAll('.navlink').forEach(function(a){ a.classList.remove('active'); });
        link.classList.add('active');
        // Initialize Sichern functionality after showing the view (guarded)
        initSichern();
      });
      
      // Add minimal handlers for saved/issued/paid to ensure other views hide Sichern
      function wireSimpleNav(name){
        var a = document.querySelector('.navlink[data-view="'+name+'"]');
        var v = document.getElementById('view-'+name);
        if (!a || !v) return;
        a.addEventListener('click', function(e){
          e.preventDefault();
          document.querySelectorAll('main section[id^="view-"]').forEach(function(s){ s.classList.add('hidden'); });
          v.classList.remove('hidden');
          document.querySelectorAll('.navlink').forEach(function(n){ n.classList.remove('active'); });
          a.classList.add('active');
        });
      }
      wireSimpleNav('saved');
      wireSimpleNav('issued');
      wireSimpleNav('paid');
      
      // Guarded, idempotente Initialisierung mit Listener-Bereinigung
      function initSichern(){
        if (window.__sichernWired) return;
        var exportBtn = document.getElementById('export_json_btn');
        var importBtn = document.getElementById('import_json_btn');
        var fileInput = document.getElementById('import_json_input');
        var statusEl = document.getElementById('sichern_status');
        if (!exportBtn || !importBtn || !fileInput) return;
        
        function setStatus(msg, isError){
          if (!statusEl) return;
          statusEl.textContent = msg || '';
          if (statusEl.classList) statusEl.classList.toggle('danger', !!isError);
        }
        function collectAll(){
          var data = {};
          for (var i=0;i<localStorage.length;i++){
            var k = localStorage.key(i);
            try { data[k] = localStorage.getItem(k); } catch(_){ }
          }
          return data;
        }
        function doExport(){
          try{
            var payload = { type:'Rechnungstool-Backup', version:1, exportedAt:new Date().toISOString(), data:collectAll() };
            var blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'rechnungstool-backup-' + new Date().toISOString().slice(0,19).replace(/[T:]/g,'-') + '.json';
            document.body.appendChild(a); a.click();
            setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
            setStatus('Export erstellt.');
          }catch(e){ setStatus('Export fehlgeschlagen.', true); }
        }
        function doImportFile(file){
          var reader = new FileReader();
          reader.onerror = function(){ setStatus('Datei konnte nicht gelesen werden.', true); };
          reader.onload = function(){
            try{
              var obj = JSON.parse(reader.result);
              var data = (obj && typeof obj==='object' && obj.data && typeof obj.data==='object') ? obj.data : obj;
              if (!data || typeof data !== 'object'){ setStatus('UngÃ¼ltiges JSON-Format.', true); return; }
              var ok=0, fail=0;
              try { localStorage.clear(); } catch(_) {}
              Object.keys(data).forEach(function(k){
                var v = data[k];
                if (typeof v !== 'string') { try { v = JSON.stringify(v); } catch(_) { v = String(v); } }
                try { localStorage.setItem(k, v); ok++; } catch(_) { fail++; }
              });
              if (fail===0) { setStatus('Import erfolgreich. Starte neuâ€¦'); setTimeout(function(){ location.reload(); }, 150); }
              else setStatus('Import teilweise erfolgreich: ' + ok + ' ok, ' + fail + ' Fehler.', true);
            }catch(_){ setStatus('Import fehlgeschlagen: UngÃ¼ltiges JSON.', true); }
          };
          reader.readAsText(file);
        }
        function clone(el){ if (!el || !el.parentNode) return el; var c=el.cloneNode(true); el.parentNode.replaceChild(c, el); return c; }

        // Vorherige Listener entfernen, dann einmalig binden
        exportBtn = clone(exportBtn);
        importBtn = clone(importBtn);
        fileInput = clone(fileInput);

        exportBtn.addEventListener('click', function(e){ e.preventDefault(); doExport(); }, true);
        importBtn.addEventListener('click', function(e){ e.preventDefault(); fileInput.value=''; fileInput.click(); }, true);
        fileInput.addEventListener('change', function(e){ var f=e.target.files&&e.target.files[0]; if (f) doImportFile(f); }, true);

        window.__sichernWired = true;
      }
    })();
  </script>
</body>
</html>
